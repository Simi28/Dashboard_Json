name: Delete Dashboard via NerdGraph

on:
  workflow_dispatch:
    inputs:
      region:
        description: 'Region (us or eu)'
        required: true
        default: 'us'

jobs:
  delete:
    runs-on: ubuntu-latest

    env:
      API_KEY: ${{ secrets.API_KEY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set NerdGraph API URL based on region
        run: |
          if [[ "${{ github.event.inputs.region }}" == "eu" ]]; then
            echo "NERDGRAPH_URL=https://api.eu.newrelic.com/graphql" >> $GITHUB_ENV
          else
            echo "NERDGRAPH_URL=https://api.newrelic.com/graphql" >> $GITHUB_ENV
          fi

      - name: Read dashboard GUID
        id: get-guid
        run: |
          GUID=$(cat rendered/guid.txt)
          echo "GUID=$GUID" >> $GITHUB_ENV

      - name: Create delete mutation payload
        run: |
          echo "{
            \"query\": \"mutation DeleteDashboard(\$guid: EntityGuid!) {
              dashboardDelete(guid: \$guid) {
                status
              }
            }\",
            \"variables\": {
              \"guid\": \"${GUID}\"
            }
          }" > rendered/delete_payload.json

      - name: Delete dashboard via NerdGraph
        run: |
          echo "🗑️ Deleting dashboard with GUID: ${GUID}"
          curl --request POST \
            --url $NERDGRAPH_URL \
            --header "Content-Type: application/json" \
            --header "API-Key: $API_KEY" \
            --data @rendered/delete_payload.json
